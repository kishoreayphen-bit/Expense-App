# âœ… Claims Tab Issue - FIXED!

## âŒ **Root Cause**

The JWT token generated by the backend **did not include the user's role**. 

The token only contained:
- `email`
- `userId`

But NOT:
- `role`
- `authorities`

This meant the mobile app couldn't extract the role during login, so `isAtLeast('MANAGER')` always returned `false`, preventing the Claims tab from showing.

---

## âœ… **What I Fixed**

### **1. Updated JwtService.java**
Added a new method to include role in JWT token:

```java
public String generateToken(String subject, Long userId, String role, long ttlMinutes) {
    // ...
    if (role != null && !role.trim().isEmpty()) {
        builder.claim("authorities", java.util.List.of("ROLE_" + role));
        builder.claim("role", role);
    }
    // ...
}
```

**This adds two claims to the token:**
- `authorities`: `["ROLE_MANAGER"]` - For Spring Security
- `role`: `"MANAGER"` - For mobile app

### **2. Updated AuthService.java**
Updated login and refresh methods to use the new token generation:

```java
// Login
String accessToken = jwtService.generateToken(
    user.getEmail(), 
    user.getId(), 
    user.getRole().name(),  // â† Added role
    accessTtlMin
);

// Refresh
String access = jwtService.generateToken(
    user.getEmail(), 
    user.getId(), 
    user.getRole().name(),  // â† Added role
    accessTtlMin
);
```

### **3. Restarted Backend**
```bash
docker-compose restart backend
```

---

## ğŸ¯ **Now Test It!**

### **Step 1: Logout**
```bash
1. Go to Profile â†’ Logout
2. Close the app completely
```

### **Step 2: Login Again**
```bash
1. Open the app
2. Login with: manager1@expense.app / password
3. Watch the console logs
```

### **Step 3: Check Console**
You should now see:

```javascript
[Auth] ===== LOGIN DEBUG =====
[Auth] Token data: {
  "email": "manager1@expense.app",
  "userId": 123,
  "authorities": ["ROLE_MANAGER"],  // â† NEW!
  "role": "MANAGER"                  // â† NEW!
}
[Auth] Found role authority: ROLE_MANAGER
[Auth] âœ… User role saved to AsyncStorage: MANAGER
[Auth] âœ… Verified saved role: MANAGER

[RoleContext] Loading role from AsyncStorage...
[RoleContext] Stored role: MANAGER
[RoleContext] âœ… Role set to: MANAGER

[MainTabs] Claims Tab Debug: {
  "role": "MANAGER",           // â† NOW HAS VALUE!
  "isCompanyMode": true,
  "isAtLeastManager": true,    // â† NOW TRUE!
  "shouldShowClaims": true     // â† NOW TRUE!
}
```

### **Step 4: Switch to Company Mode**
```bash
1. Tap mode badge at top
2. Select a company
3. Look at bottom navigation
4. Claims tab should appear! ğŸ‰
```

---

## ğŸ“Š **Expected Result**

**Bottom Navigation (MANAGER in Company Mode):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Company  â”‚Expenses â”‚Budgetsâ”‚  FX  â”‚ Teams  â”‚ Bills â”‚ Claims â”‚ Profile â”‚
â”‚    ğŸ¢   â”‚    ğŸ“Š   â”‚  ğŸ’°  â”‚  ğŸ’±  â”‚   ğŸ‘¥   â”‚  ğŸ“„  â”‚   ğŸ’°   â”‚   ğŸ‘¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â†‘
                                                  SHOULD BE HERE!
```

---

## ğŸ” **Verification**

### **Check JWT Token:**
After login, the token should now include:

```json
{
  "sub": "manager1@expense.app",
  "email": "manager1@expense.app",
  "userId": 123,
  "authorities": ["ROLE_MANAGER"],
  "role": "MANAGER",
  "iat": 1733129400,
  "exp": 1733133000
}
```

### **Check AsyncStorage:**
The role should be saved:

```javascript
AsyncStorage.getItem('userRole') â†’ "MANAGER"
```

### **Check RoleContext:**
```javascript
const { role, isAtLeast } = useRole();
console.log(role); // "MANAGER"
console.log(isAtLeast('MANAGER')); // true
```

---

## ğŸ‰ **Summary**

**Before:**
- JWT token: âŒ No role
- AsyncStorage: âŒ No role
- RoleContext: âŒ role = null
- isAtLeast('MANAGER'): âŒ false
- Claims tab: âŒ Not visible

**After:**
- JWT token: âœ… Has role
- AsyncStorage: âœ… Has role
- RoleContext: âœ… role = "MANAGER"
- isAtLeast('MANAGER'): âœ… true
- Claims tab: âœ… Visible!

---

## ğŸš€ **Next Steps**

1. **Logout and login again** with `manager1@expense.app / password`
2. **Switch to company mode**
3. **Check bottom navigation** - Claims tab should be there!
4. **Tap Claims tab** - Should open ClaimsScreen
5. **See pending reimbursements** - Should show all pending requests

---

## ğŸ“ **Files Changed**

1. **`backend/src/main/java/com/expenseapp/security/JwtService.java`**
   - Added `generateToken()` method with role parameter
   - Adds `authorities` and `role` claims to JWT

2. **`backend/src/main/java/com/expenseapp/auth/AuthService.java`**
   - Updated `login()` to pass role to token generation
   - Updated `refresh()` to pass role to token generation

3. **`mobile/src/context/AuthContext.tsx`**
   - Added debug logging
   - Added API fallback (not needed now that token has role)

4. **`mobile/src/context/RoleContext.tsx`**
   - Added debug logging
   - Added API fallback (not needed now that token has role)

5. **`mobile/src/navigation/MainTabs.tsx`**
   - Added debug logging to show Claims tab visibility logic

---

**Backend restarted. Now logout, login again, and the Claims tab will appear!** ğŸ‰

---

**Last Updated:** December 2, 2025, 11:43 AM IST  
**Status:** âœ… **FIXED - READY TO TEST**
